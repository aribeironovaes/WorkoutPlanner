<html>
  <head>
    <title>
      Workout
    </title>
    <script type="text/javascript">
      // make the commonjs happy
      window.exports = {}
    </script>
    <script src="MyMath.js"></script>
    <script src="model.js"></script>
    <script src="rx.all.js"></script>
    <script src="canvasjs.min.js"></script>
    <script type="text/javascript">

  function _loadWorkoutWithData(sportType, ftp, tPace, workoutText, outputUnit, email) {
    var userProfile = new UserProfile(ftp, tPace, email);
    var builder = new WorkoutBuilder(userProfile, sportType, outputUnit).withDefinition(workoutText);
    var workout_pretty = builder.getPrettyPrint();
    _setInnerText("workout_pretty", workout_pretty);

    // Timeline chart
    var points = builder.getInterval().getTimeSeries();

    var chartTimeline = new CanvasJS.Chart("chartTimelineContainer",
    {
      title:{
        text: ""
      },
      axisX:{
        title: "time",
        suffix: "min",
        gridColor: "lightgray" ,
        gridThickness: 1,
      },
      axisY:{
        title: "intensity",
        labelAngle: 45,
        minimum: 45,
        suffix: "%",
        gridThickness: 0,
      },
      data: [
      {
          type: "area",
          fillOpacity: 0.3,
          markerType: "none",
          dataPoints: points
      }
      ]
    });

    chartTimeline.render();

    // Zones chart
    var dataPoints = builder.getInterval().getTimeInZones().map(
      function(zone) {
        return {
          y: zone.duration.getSeconds(),
          legendText: zone.name + "(" + zone.duration.toString() + ")",
          indexLabel: zone.name
        }
      }
    );

    var chartZones = new CanvasJS.Chart("chartZonesContainer", {
      title:{
        text: "Time in zones"
      },
      data: [
      {
        type: "pie",
        showInLegend: true,
        dataPoints: dataPoints
      }]
    });
    chartZones.render();
  }

  function _setInnerText(element_id, text) {
    var element = document.getElementById(element_id);
    if (element) {
      element.innerText = text;
    } else {
      console.log("element " + element_id + " does not exist!");
    }
  }

  function _init() {
    // Check if there is a url parameter
    var params = getQueryParams();
    if (params.w && params.ftp && params.tpace && params.st && params.ou && params.email) {
      _loadWorkoutWithData(params.st, params.ftp, params.tpace, params.w, params.ou, params.email);
    }
  }

  function getQueryParams() {
      var qs = document.location.search;
      qs = qs.split("+").join(" ");

      var params = {}, tokens,
          re = /[?&]?([^=]+)=([^&]*)/g;

      while (tokens = re.exec(qs)) {
          params[decodeURIComponent(tokens[1])]
              = decodeURIComponent(tokens[2]);
      }

      return params;
  }

  var windowLoads = Rx.Observable.fromEvent(window, "DOMContentLoaded");
  var windowLoadsSubscription = windowLoads.forEach(
    function() {
      _init();
      windowLoadsSubscription.dispose();
    }
  );

  </script>
  <style>
  .font {
    font-family:"Calibri",Arial;
    font-size: 100%;
  }

  .selected {
    background: yellow;
  }

  </style>
  </head>
  <body class="font">
  <div id="chartTimelineContainer" style="height: 300px; width: 100%;">
  </div>
  <div id="chartZonesContainer" style="height: 200px; width: 100%;">
  </div>
  <div id="workout_pretty">
  </div>
  <hr />
  </body>
</html>