<html>
  <head>
    <title>
      Workout Planner
    </title>
  <script type="text/javascript">
    // make the commonjs happy
    window.exports = {}
  </script>
  <script src="MyMath.js"></script>
  <script src="model.js"></script>
  <script src="rx.all.js"></script>
  <script type="text/javascript">

  var workoutPersisted = new PersistedItem("workout-new");
  var sportTypePersisted = new PersistedItem("sport-type");
  var ftpPersisted = new PersistedItem("ftp");
  var tPacePersisted = new PersistedItem("tpace");

  function _onKeyChanged(e) {
    var ch = String.fromCharCode(e.keyCode);
    if (!IntervalParser.shouldParse(ch)) {
        return;
    }
    _loadWorkout(ch);
  }

  function _loadWorkout(ch) {
    var workoutText = _getValue("workout") + ch;

    var sportType = parseInt(_getValue("sltSportType"));

    // TODO: make it work with other units
    var tPaceString = _getValue("txtTPace");
    var tPace = _extractNumber(tPaceString, 60, ":", "min/mi");
    var ftp = parseInt(_getValue("txtFtp"));
    var outputUnit = parseInt(_getValue("sltOutputUnit"));

    var iframe = document.getElementById("workout_frame");
    var download_anchor = document.getElementById("download_mrc");

    // TODO: Make this nicer by iterating through a map of elements and
    // calling encoreURIComponent on each one
    var params = "?w=" + encodeURIComponent(workoutText) +
      "&st=" + encodeURIComponent(sportType) +
      "&ftp=" + encodeURIComponent(ftp) +
      "&tpace=" + encodeURIComponent(tPace) +
      "&ou=" + encodeURIComponent(outputUnit);

    var url = "workout_view.html" + params;
    var mrc_url = "workout.mrc" + params ;
    iframe.src = url;
    download_anchor.href = mrc_url;

    workoutPersisted.save(workoutText);
    sportTypePersisted.save(sportType);
    tPacePersisted.save(tPaceString);
    ftpPersisted.save(ftp);
  }
  
  function _extractNumber(numberString, decimalMultiplier, strSeparator, strSuffix) {
    var indexSuffix = numberString.indexOf(strSuffix);
    var indexSeparator = numberString.indexOf(strSeparator);
    // Lets be forgiving if the user didn't specify the separators
    // 6:00 => 6:00 min/mi
    // 6 min/mi => 6:00 min/mi
    // 6 => 6:00 min/mi
    if (indexSuffix < 0) {
      indexSuffix = numberString.length;
    }
    if (indexSeparator < 0) {
      indexSeparator = numberString.length;
    }
    var integerPart = parseInt(numberString.substr(0, indexSeparator));
    var fractionPart = parseInt(numberString.substr(indexSeparator+1, indexSuffix - indexSeparator));
    if (isNaN(fractionPart)) {
      fractionPart = 0;
    }
    return integerPart + fractionPart/decimalMultiplier;
  }

  function _setValue(element_id, text) {
    if (!text) {
      return;
    }
    var element = document.getElementById(element_id);
    if (element) {
      element.value = text;
    } else {
      console.log("element " + element_id + " does not exist!");
    }
  }

  function _getValue(element_id) {
    var element = document.getElementById(element_id);
    if (element) {
      return element.value;
    } else {
      console.log("element " + element_id + " does not exist!");
    }
  }

  function _init() {
    // Load previous data
    _setValue("workout", workoutPersisted.load());
    _setValue("sltSportType", sportTypePersisted.load());
    _setValue("txtFtp", ftpPersisted.load());
    _setValue("txtTPace", tPacePersisted.load());

    // Load workouts
    var loadWorkoutClicks = Rx.Observable.fromEvent(
      document.getElementById("btnLoadWorkout"),
      "click"
    );
    var loadWorkoutClicksSubscription = loadWorkoutClicks.forEach(
      _loadWorkout("")
    );

    // Selection changed
    var sltSportTypeOnChange = Rx.Observable.fromEvent(
      document.getElementById("sltSportType"),
      "change");
    var sltSportTypeOnChangeSubscription = sltSportTypeOnChange.forEach(
      _initOutputUnit
    );

    // Key Pressed
    var txtAreaOnKey = Rx.Observable.fromEvent(
      document.getElementById("workout"),
      "keypress");
    var txtAreaOnKeySubscription = txtAreaOnKey.forEach(
      _onKeyChanged
    );

    _initOutputUnit();
  }

  function _initOutputUnit() {
    var sltOutputUnitElement = document.getElementById("sltOutputUnit");
    var sltSportTypeElement = document.getElementById("sltSportType");

    var isBike = sltSportTypeElement.value == 1;
    var styleHide = "none";
    var styleShow = "";
    sltOutputUnitElement.options[0].style.display = isBike ? styleShow : styleHide;
    sltOutputUnitElement.options[1].style.display = isBike ? styleHide : styleShow;
    sltOutputUnitElement.options[2].style.display = isBike ? styleHide : styleShow;
    sltOutputUnitElement.options[3].style.display = isBike ? styleHide : styleShow;
    sltOutputUnitElement.options[4].style.display = isBike ? styleHide : styleShow;
    sltOutputUnitElement.value = isBike ? "1" : "2";
  }

  var windowLoads = Rx.Observable.fromEvent(window, "DOMContentLoaded");
  var windowLoadsSubscription = windowLoads.forEach(
    function() {
      _init();
      windowLoadsSubscription.dispose();
    }
  );

  </script>
  <style>
  .font {
    font-family:"Calibri",Arial;
    font-size: 100%;
  }

  .selected {
    background: yellow;
  }

  </style>
  </head>
  <body class="font">
  <form>
    <h1> User Settings </h1>
    Bike FTP: <input id="txtFtp" width="20" placeholder="245"></input><br />
    Run T-Pace: <input id="txtTPace" width="20" placeholder="7:30 min/mi"></input> <br />
    <br />
    <h1> Workout Settings </h1>
    Workout Type:
    <select id="sltSportType">
      <option value="1">Bike</option>
      <option value="2">Run</option>
    </select> <br />
    Output Unit:
    <select id="sltOutputUnit">
      <option value="1">Watts</option>
      <option value="2">Min/Mile</option>
      <option value="3">Mph</option>
      <option value="4">Min/Km</option>
      <option value="5">Km/h</option>
      <option value="0">IF</option>
    </select>
    <br/>
    <textarea id="workout" style="height: auto; width: 100%;">
    </textarea>
    <input id="btnLoadWorkout" type="button" value="Load Workout" class="btn"/>
  </form>
  <a id="download_mrc" >Download MRC</a>
  <iframe id="workout_frame" style="height: 100%; width: 100%"/>
  <hr />
  </body>
</html>