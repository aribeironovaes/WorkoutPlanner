<html>
  <head>
    <title>
      WorkoutPlanner
    </title>
  <script type="text/javascript">
    // make the commonjs happy
    window.exports = {}
  </script>
  <script src="MyMath.js"></script>
  <script src="model.js"></script>
  <script src="rx.all.js"></script>
  <script type="text/javascript">

  var workoutPersisted = new PersistedItem("workout-new");
  var sportTypePersisted = new PersistedItem("sport-type");
  var ftpPersisted = new PersistedItem("ftp");
  var tPacePersisted = new PersistedItem("tpace");

  function _loadWorkout() {
    var workoutText = _getValue("workout");
    var sportType = parseInt(_getValue("sltSportType"));
    var tPace = parseFloat(_getValue("txtTPace"));
    var ftp = parseInt(_getValue("txtFtp"));
    var outputUnit = parseInt(_getValue("sltOutputUnit"));

    var iframe = document.getElementById("workout_frame");
    var anchor = document.getElementById("workout_link");
    var download_anchor = document.getElementById("download_mrc");

    // TODO: Make this nicer by iterating through a map of elements and 
    // calling encoreURIComponent on each one
    var params = "?w=" + encodeURIComponent(workoutText) +
      "&st=" + encodeURIComponent(sportType) +
      "&ftp=" + encodeURIComponent(ftp) +
      "&tpace=" + encodeURIComponent(tPace) +
      "&ou=" + encodeURIComponent(outputUnit);

    var url = "workout_view.html" + params;
    var mrc_url = "workout.mrc" + params ;
    iframe.src = url;
    anchor.href = url;
    download_anchor.href = mrc_url;

    workoutPersisted.save(workoutText);
    sportTypePersisted.save(sportType);
    tPacePersisted.save(tPace);
    ftpPersisted.save(ftp);
  }

  function _setValue(element_id, text) {
    if (!text) {
      return;
    }
    var element = document.getElementById(element_id);
    if (element) {
      element.value = text;
    } else {
      console.log("element " + element_id + " does not exist!");
    }
  }

  function _getValue(element_id) {
    var element = document.getElementById(element_id);
    if (element) {
      return element.value;
    } else {
      console.log("element " + element_id + " does not exist!");
    }
  }

  function _init() {
    // Load previous data
    _setValue("workout", workoutPersisted.load());
    _setValue("sltSportType", sportTypePersisted.load());
    _setValue("txtFtp", ftpPersisted.load());
    _setValue("txtTPace", tPacePersisted.load());

    // Load workouts
    var loadWorkoutClicks = Rx.Observable.fromEvent(
      document.getElementById("btnLoadWorkout"),
      "click"
    );
    var loadWorkoutClicksSubscription = loadWorkoutClicks.forEach(
      _loadWorkout
    );

    // Selection changed
    var sltSportTypeOnChange = Rx.Observable.fromEvent(
      document.getElementById("sltSportType"),
      "change");
    var sltSportTypeOnChangeSubscription = sltSportTypeOnChange.forEach(
      _initOutputUnit
    );

    _initOutputUnit();
  }

  function _initOutputUnit() {
    var sltOutputUnitElement = document.getElementById("sltOutputUnit");
    var sltSportTypeElement = document.getElementById("sltSportType");

    var isBike = sltSportTypeElement.value == 1;
    var styleHide = "none";
    var styleShow = "";
    sltOutputUnitElement.options[0].style.display = isBike ? styleShow : styleHide;
    sltOutputUnitElement.options[1].style.display = isBike ? styleHide : styleShow;
    sltOutputUnitElement.options[2].style.display = isBike ? styleHide : styleShow;
    sltOutputUnitElement.options[3].style.display = isBike ? styleHide : styleShow;
    sltOutputUnitElement.options[4].style.display = isBike ? styleHide : styleShow;
    sltOutputUnitElement.value = isBike ? "1" : "2";
  }

  var windowLoads = Rx.Observable.fromEvent(window, "DOMContentLoaded");
  var windowLoadsSubscription = windowLoads.forEach(
    function() {
      _init();
      windowLoadsSubscription.dispose();
    }
  );

  // TODO: Don't know how to use react and cancel the event!
  document.onkeydown = function(e) {
    if (e.which == 76) {
      _loadWorkout();
      e.stopPropagation();

      return false;
    } else {
      return true;
    }
  };

  </script>
  <style>
  .font {
    font-family:"Calibri",Arial;
    font-size: 100%;
  }

  .selected {
    background: yellow;
  }

  </style>
  </head>
  <body class="font">
  <form>
    <select id="sltSportType">
      <option value="1">Bike</option>
      <option value="2">Run</option>
    </select>
    <input id="txtFtp" width="20" placeholder="bike ftp"></input>
    <input id="txtTPace" width="20" placeholder="run t-pace"></input>
    <select id="sltOutputUnit">
      <option value="1">Watts</option>
      <option value="2">Min/Mile</option>
      <option value="3">Mph</option>
      <option value="4">Min/Km</option>
      <option value="5">Km/h</option>
      <option value="0">IF</option>
    </select>
    <input id="btnLoadWorkout" type="button" value="Load Workout" class="btn"/>
    <br/>
    <textarea id="workout" style="height: auto; width: 100%;">
    </textarea>
  </form>
  <a id="workout_link" >Printer Friendly</a>
  <a id="download_mrc" >Download MRC</a>
  <iframe id="workout_frame" style="height: 100%; width: 100%"/>
  <hr />
  </body>
</html>