<html>
  <head>
    <title>
      Workout Planner
    </title>
  <script type="text/javascript">
    // make the commonjs happy
    window.exports = {}
  </script>
  <script src="ui.js"></script>
  <script src="model.js"></script>
  <script src="rx.all.js"></script>
  <script src="canvasjs.min.js"></script>
  <script type="text/javascript">

  function _onKeyChanged(e) {
    var ch = String.fromCharCode(e.keyCode);
    if (!IntervalParser.shouldParse(ch)) {
        return;
    }
    _loadWorkout(ch);
  }

  function _onButtonPressed(e) {
    _loadWorkout("");
  }

  function _loadWorkout(ch) {
    // TODO: this is incorrect (specially if you type in the middle of the text)
    var workoutText = _getValue("workout") + ch;

    var sportType = _getValue("sltSportType");

    var email = _getValue("txtEmail");
    var tPace = _getValue("txtTPace");
    var ftp = _getValue("txtFtp");
    var outputUnit = _getValue("sltOutputUnit");

    var iframe = document.getElementById("workout_frame");
    var download_anchor = document.getElementById("download_mrc");
    var download_anchor_zwo = document.getElementById("download_zwo");
    var email_send_workout_anchor = document.getElementById("email_send_workout");

    var qp = new UI.QueryParams(workoutText, ftp, tPace, sportType, outputUnit, email);
    var params = qp.getURL();

    var url = "workout_view.html" + params;
    var mrc_url = "workout.mrc" + params;
    var zwo_url = "workout.zwo" + params;
    var email_url = "send_mail" + params;

    iframe.src = url;
    download_anchor.href = mrc_url;
    download_anchor_zwo.href = zwo_url;
    email_send_workout_anchor.href = email_url;

    qp.saveToStorage();
  }
 
  function _setValue(element_id, text) {
    if (!text) {
      return;
    }
    var element = document.getElementById(element_id);
    if (element) {
      element.value = text;
    } else {
      console.log("element " + element_id + " does not exist!");
    }
  }

  function _getValue(element_id) {
    var element = document.getElementById(element_id);
    if (element) {
      return element.value;
    } else {
      console.log("element " + element_id + " does not exist!");
    }
  }

  function _init() {
    // Initialize the fields
    var qp = new UI.QueryParams();
    _setValue("workout", qp.workout_text);
    _setValue("sltSportType", qp.workout_type);
    _setValue("txtFtp", qp.ftp_watts);
    _setValue("txtTPace", qp.t_pace);
    _setValue("sltOutputUnit", qp.output_unit)    
    _setValue("txtEmail", qp.email);

    // Load workouts
    var loadWorkoutClicks = Rx.Observable.fromEvent(
      document.getElementById("btnLoadWorkout"),
      "click"
    );
    var loadWorkoutClicksSubscription = loadWorkoutClicks.forEach(
      _onButtonPressed
    );

    // Selection changed
    var sltSportTypeOnChange = Rx.Observable.fromEvent(
      document.getElementById("sltSportType"),
      "change");
    var sltSportTypeOnChangeSubscription = sltSportTypeOnChange.forEach(
      _initOutputUnit
    );

    // Key Pressed
    var txtAreaOnKey = Rx.Observable.fromEvent(
      document.getElementById("workout"),
      "keypress");
    var txtAreaOnKeySubscription = txtAreaOnKey.forEach(
      _onKeyChanged
    );

    _initOutputUnit();
  }

  function _initOutputUnit() {
    var sltOutputUnitElement = document.getElementById("sltOutputUnit");
    var sltSportTypeElement = document.getElementById("sltSportType");

    var isBike = sltSportTypeElement.value == 1;
    var styleHide = "none";
    var styleShow = "";
    sltOutputUnitElement.options[0].style.display = isBike ? styleShow : styleHide;
    sltOutputUnitElement.options[1].style.display = isBike ? styleHide : styleShow;
    sltOutputUnitElement.options[2].style.display = isBike ? styleHide : styleShow;
    sltOutputUnitElement.options[3].style.display = isBike ? styleHide : styleShow;
    sltOutputUnitElement.options[4].style.display = isBike ? styleHide : styleShow;
    sltOutputUnitElement.value = isBike ? "1" : "2";

	var z = {};
	if (isBike) {
		z = Model.ZonesMap.getBikeZoneMap();
	} else {
		z = Model.ZonesMap.getRunZoneMap();
	}

	var chart = new CanvasJS.Chart("chartContainer",
	{
		title:{
			text: "Bike Zones",
		},
		axisY: {
			includeZero:false,
			title: "Zones",
			interval: 5,
		}, 
		axisX: {
			interval:1,
			title: "Percentage",
		},
		data: [
		{
			type: "rangeBar",
			showInLegend: false,
			yValueFormatString: "#0.##%",
			indexLabel: "{y[#index]}",
			dataPoints: [   // Y: [Low, High]
				{x: 1, y:[z[1].low, z[1].high], label: z[1].name},
				{x: 2, y:[z[2].low, z[2].high], label: z[2].name},
				{x: 3, y:[z[3].low, z[3].high], label: z[3].name},
				{x: 4, y:[z[4].low, z[4].high], label: z[4].name},
				{x: 5, y:[z[5].low, z[5].high], label: z[5].name},
			]
		}
		]
	});
	chart.render();
  }

  var windowLoads = Rx.Observable.fromEvent(window, "DOMContentLoaded");
  var windowLoadsSubscription = windowLoads.forEach(
    function() {
      _init();
      windowLoadsSubscription.dispose();
    }
  );

  </script>
  <style>
  .font {
    font-family:"Calibri",Arial;
    font-size: 100%;
  }

  .selected {
    background: yellow;
  }

  </style>
  </head>
  <body class="font">
  <form>
    <h1> User Settings </h1>
    Bike FTP: <input id="txtFtp" width="20" placeholder="245"></input><br />
    Run T-Pace: <input id="txtTPace" width="20" placeholder="7:30 min/mi"></input> <br />
    Email: <input id="txtEmail" width="20" placeholder="foo@gmail.com"></input> <br />
    <br />
    <h1> Workout Settings </h1>
    Workout Type:
    <select id="sltSportType">
      <option value="1">Bike</option>
      <option value="2">Run</option>
    </select> <br />
    Output Unit:
    <select id="sltOutputUnit">
      <option value="1">Watts</option>
      <option value="2">Min/Mile</option>
      <option value="3">Mph</option>
      <option value="4">Min/Km</option>
      <option value="5">Km/h</option>
      <option value="0">IF</option>
    </select>
    <br/>
  	<div id="chartContainer" style="height: 400px; width: 100%;" >
	</div>
    <textarea id="workout" style="height: 200px; width: 100%;">
    </textarea>
    <input id="btnLoadWorkout" type="button" value="Load Workout" class="btn"/>
  </form>
  <a id="download_mrc" >Download MRC</a>
  <a id="download_zwo" >Download ZWO</a>
  <a id="email_send_workout" >Email Workout</a>
  <iframe id="workout_frame" style="height: 100%; width: 100%"/>
  <hr />
  </body>
</html>